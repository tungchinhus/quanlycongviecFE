<div class="user-list-container">
  @if (isLoading()) {
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Đang tải danh sách người dùng...</p>
    </div>
  } @else {
    @if (users().length === 0) {
      <div class="empty-state">
        <mat-icon>people_outline</mat-icon>
        <h3>Chưa có người dùng nào</h3>
        <p>Hãy tạo người dùng mới để bắt đầu</p>
      </div>
    } @else {
      <div class="table-container">
        <table mat-table [dataSource]="users()" class="users-table">
          <!-- Name Column -->
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef>Tên</th>
            <td mat-cell *matCellDef="let user">
              <div class="user-info">
                <mat-icon class="user-icon">person</mat-icon>
                <span class="user-name">{{ user.name }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Email Column -->
          <ng-container matColumnDef="email">
            <th mat-header-cell *matHeaderCellDef>Email</th>
            <td mat-cell *matCellDef="let user">
              <span class="email-text">{{ user.email }}</span>
            </td>
          </ng-container>

          <!-- Roles Column -->
          <ng-container matColumnDef="roles">
            <th mat-header-cell *matHeaderCellDef>Quyền</th>
            <td mat-cell *matCellDef="let user">
              <div class="roles-container">
                @for (role of user.roles; track role) {
                  <mat-chip [color]="getRoleColor(role)" class="role-chip">
                    {{ role }}
                  </mat-chip>
                }
                @if (user.roles.length === 0) {
                  <span class="no-role">Không có quyền</span>
                }
              </div>
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Trạng thái</th>
            <td mat-cell *matCellDef="let user">
              @if (user.isActive !== false) {
                <mat-chip color="primary" class="status-chip">
                  <mat-icon>check_circle</mat-icon>
                  Hoạt động
                </mat-chip>
              } @else {
                <mat-chip color="warn" class="status-chip">
                  <mat-icon>cancel</mat-icon>
                  Vô hiệu hóa
                </mat-chip>
              }
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="actions-header">Thao tác</th>
            <td mat-cell *matCellDef="let user" class="actions-cell">
              <div class="actions-container">
                <button 
                  mat-icon-button 
                  color="accent"
                  (click)="onUserSelected.emit(user)"
                  matTooltip="Quản lý quyền">
                  <mat-icon>admin_panel_settings</mat-icon>
                </button>
                <button 
                  mat-icon-button 
                  color="primary"
                  (click)="onSyncRoles(user)"
                  [disabled]="!isAdmin() || isSyncing(user.id)"
                  matTooltip="Đồng bộ roles từ Firebase">
                  @if (isSyncing(user.id)) {
                    <mat-icon class="spinning">sync</mat-icon>
                  } @else {
                    <mat-icon>sync</mat-icon>
                  }
                </button>
                <button 
                  mat-icon-button 
                  color="primary"
                  (click)="onEdit(user)"
                  [disabled]="!isAdmin()"
                  matTooltip="Chỉnh sửa">
                  <mat-icon>edit</mat-icon>
                </button>
                <button 
                  mat-icon-button 
                  color="warn"
                  (click)="onDelete(user.id, user.name)"
                  [disabled]="!isAdmin() || currentUserId() === user.id || user.isActive === false"
                  [matTooltip]="user.isActive === false ? 'Người dùng đã bị vô hiệu hóa' : 'Vô hiệu hóa người dùng'">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="user-row"></tr>
        </table>
      </div>
    }
  }
</div>

